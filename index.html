<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#317EFB">
<title>BG Tracker</title>
<style>
/* Page */
body { margin:0; font-family:Inter,system-ui,Arial; background:#1b1b1b; color:#fff; padding:18px }
.heading { font-size:28px; font-weight:800; margin:20px 0 12px; color:#fff }
.headingTitle { font-size:16px; font-weight:700;gap:10px; margin:-12px 0 -20px; color:#000;
 text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  -webkit-background-clip: text;
     -moz-background-clip: text;
          background-clip: text;
position: sticky;
  top: 0;
  z-index: 1000;
  background: rgba(27, 27, 27, 0.9); /* matches page background */
  backdrop-filter: blur(2px);            /* soft blur for modern look */
  padding: 2px 0;
  text-align: center;
   text-align:right }

/* Sections */
.input-section { margin-bottom:18px } /* slightly reduced to fit new summary spacing */
.chart-section { padding:18px; margin-bottom:28px }
.stats-section { margin-bottom:28px }

/* New summary panel (A) */
.summary-panel { display:flex; gap:16px; align-items:center; justify-content:flex-start; margin:18px 0; padding:10px 12px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.12)); color:#fff; box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
.summary-panel .stat { font-size:14px; color:rgba(255,255,255,0.9) }
.summary-panel .stat .value { font-weight:800; font-size:18px; margin-left:8px; color:#fff }

/* Grids */
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:10px }
.chip, .select-btn { padding:14px 14px; background:#222; cursor:pointer; text-align:center; font-size:16px; color:#fff; border:white}
.chip.active, .select-btn.active { background:#fff; color:#000; }
.save-wrap{ display:flex; align-items:center; gap:12px; margin-top:12px;}
.save-btn {
  width: 100%;                  /* full width */
  padding: 16px 22px;           /* keep it touch-friendly */
  display: flex;                 /* allow checkmark inside */
  align-items: center;
  justify-content: center;       /* center text and check */
  gap: 8px;                      /* space between text and check */
  background: linear-gradient(135deg,#00ff99,#00cccc);
  color: #000;
  border: 0;
  font-weight: 900;
  font-size: 16px;
  cursor: pointer;
  border-radius: 8px;
  position: relative;
}

.save-btn .checkmark {
  display: inline-flex;          /* inline flex for alignment */
  align-items: center;
  justify-content: center;
  opacity: 0;                    /* hide by default */
  transform: scale(0.6);
  transition: all 0.36s;
}

.save-btn .checkmark.show {
  opacity: 1;
  transform: scale(1);
}

.button-muted{ padding:10px 14px; border-radius:8px; background:#222; color:#fff; border:0 }

/* Cards */
.cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:16px }
/* Base flat accent style */
.comp-card {
  background: #202225;
  border-left: 6px solid transparent;
  border-radius: 10px;
  padding: 14px;
  color: #fff;
  box-shadow: 0 4px 14px rgba(0,0,0,0.5);
  transition: all 0.25s ease;
position: relative;        /* add this so ::before works */
  overflow: hidden;          /* keeps glow tidy inside corners */
}

.comp-card:hover {
 background: #26282b;
  transform: translateY(-3px);
}

comp-card::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 6px;
  border-radius: 10px 0 0 10px;
  box-shadow: 0 0 8px currentColor;
  opacity: 0.4;
}

.comp-card .card-title { font-size:18px; font-weight:900; margin-bottom:8px }
.comp-card .big { font-size:18px; font-weight:800 }
.comp-card .small { font-size:13px; color:rgba(255,255,255,0.85) }

.comp-demons { border-left-color: #9b4dff; }
.comp-dragons { border-left-color: #ff6b6b; }
.comp-mechs { border-left-color: #f4d03f; }
.comp-murlocs { border-left-color: #2ecc71; }
.comp-quilboar { border-left-color: #d35400; }
.comp-pirates { border-left-color: #95a5a6; }
.comp-beasts { border-left-color: #27ae60; }
.comp-elementals { border-left-color: #3498db; }
.comp-undead { border-left-color: #2c3e50; }
.comp-naga { border-left-color: #1e90ff; }
.comp-menagerie { border-left-color: #8e44ad; }


/* subtle overlay stripe effect to give depth */
.comp-card::after { content:""; position:absolute; inset:0; pointer-events:none; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08)); mix-blend-mode: overlay; }

/* hover */
.comp-card:hover { transform: translateY(-6px); box-shadow: 0 14px 40px rgba(0,0,0,0.55); }

/* Small helpers */
.small { font-size:14px; color:#cccccc }
.big { font-weight:700; font-size:24px }
.card-title { font-size:22px; font-weight:700; margin-bottom:8px }
canvas { width:100%; display:block }

/* check, modal, toast */
.checkmark{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;opacity:0;transform:scale(0.6);transition:all .36s}
.checkmark.show{opacity:1;transform:scale(1)}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:12px}
.modal{background:#0b0b0b;padding:12px;border-radius:10px;max-width:720px;width:100%;max-height:80vh;overflow:auto}
.match-row{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
.del-btn{background:#3a2b2b;border:0;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}

/* C) chart canvas glow styles (CSS) - complements the ctx shadow */
.canvas-glow {  }

/* responsive tweak so that canvas height can be set in script reliably */
.chart-canvas { display:block; width:100%; height:auto; }

.custom-select {
  width: 100%;           /* full width on mobile */
  max-width: 200px;      /* optional max width */
  padding: 8px 12px;    /* comfortable touch target */
  font-size: 14px;       /* readable on small screens */
  border-radius: 8px;    /* rounded corners */
  border: 1px solid #ccc;
  background: #222;      /* match your dark theme */
  color: #fff;
  appearance: none;      /* remove default arrow */
  -webkit-appearance: none;
  -moz-appearance: none;
  cursor: pointer;
margin-top: 12px;
}

.custom-select:focus {
  outline: none;
  border-color: #00ff99;
  box-shadow: 0 0 0 2px rgba(0, 255, 153, 0.2);
}


</style>
</head>
<body>

<div class="headingTitle">BG TRACKER</div>
<div class="heading">Match Entry</div>
<div class="input-section" id="input-card">
  <div class="small">Composition</div>
  <div class="grid" id="composition-chips"></div>
  <div class="small" style="margin-top:10px">Place</div>
  <div class="grid" id="places"></div>
  <div class="small" style="margin-top:10px">Playstyle</div>
  <div class="grid" id="playstyles"></div>
  <div class="small" style="margin-top:10px">Tier 3 Turn</div>
  <div class="grid" id="tier-buttons"></div>
  <div class="save-wrap"><button class="save-btn" id="save-match">Save Match <span id="save-check" class="checkmark" aria-hidden="true">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2fe0a8" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M4 12.5l5 4L20 6"/>
    </svg>
  </span></button>
</div>

<!-- A) New small summary section inserted here -->
<div id="summary" class="summary-panel" aria-live="polite">
  <div class="stat">Total matches overall: <span id="totalMatches" class="value">0</span></div>
  <div class="stat">Average placement overall: <span id="avgPlacementOverall" class="value">-</span></div>
</div>

<div class="heading">Average Placement per Composition</div>
<div class="chart-section"><canvas id="avg-place-chart" class="canvas-glow chart-canvas"></canvas></div>

<div class="heading">Average Placement by Playstyle</div>
<div class="chart-section"><canvas id="playstyle-chart" class="canvas-glow chart-canvas"></canvas></div>

<div class="heading">Average Placement by Tier 3 Turn</div>
<div class="chart-section"><canvas id="tier-chart" class="canvas-glow chart-canvas"></canvas></div>

<div class="heading">Composition Stats</div>
<div style="margin-bottom:10px">
  <label for="sort-cards">Sort by: </label>
  <select id="sort-cards" class="custom-select">
    <option value="matches">Number of matches</option>
    <option value="avg">Average placement</option>
  </select>
</div>

<div class="stats-section"><div class="cards" id="cards"></div></div>

<div style="display:flex;gap:10px;margin-top:8px">
  <button id="export-data" class="button-muted">Export Data</button>
  <button id="import-data" class="button-muted">Import Data</button>
  <button id="clear-data" class="button-muted">Clear Data</button>
  <button id="show-all" class="button-muted">Show All Matches</button>
</div>

<div id="modal-bg" class="modal-bg" style="display:none"></div>

<script>
const COMPS=['Demons','Dragons','Mechs','Murlocs','Quilboar','Pirates','Beasts','Elementals','Undead','Naga','Menagerie'];
const PLAYS=['Tempo','Balanced','Greed'];
const TIER3=[3,4,5,6];
let state = {
  comp: COMPS[0],
  place: 1,
  play: PLAYS[0],
  tier: '3',
  matches: [],
  sortBy: 'matches' // default sort by number of matches
};
let db;

function openDb(){return new Promise(r=>{const req=indexedDB.open('bg-db',1);req.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('matches'))d.createObjectStore('matches',{keyPath:'id'});};req.onsuccess=e=>{db=e.target.result;r()};});}
function addMatch(m){return new Promise(r=>{const tx=db.transaction('matches','readwrite');tx.objectStore('matches').put(m);tx.oncomplete=()=>r();});}
function deleteMatch(id){return new Promise((res,rej)=>{const tx=db.transaction('matches','readwrite');tx.objectStore('matches').delete(id);tx.oncomplete=()=>res();tx.onerror=(e)=>rej(e);});}
function getAll(){return new Promise(r=>{const tx=db.transaction('matches','readonly');tx.objectStore('matches').getAll().onsuccess=e=>r(e.target.result||[]);});}
function clearAll(){return new Promise(r=>{const tx=db.transaction('matches','readwrite');tx.objectStore('matches').clear();tx.oncomplete=()=>r();});}
function uid(){return Date.now().toString()+'_'+Math.random().toString(36).slice(2,6)}

function buildUI(){
  const compEl=document.getElementById('composition-chips');compEl.innerHTML='';COMPS.forEach(c=>{const d=document.createElement('div');d.className='chip';d.textContent=c;d.onclick=()=>{state.comp=c;render()};compEl.appendChild(d)});
  const pEl=document.getElementById('places');pEl.innerHTML='';for(let i=1;i<=8;i++){const b=document.createElement('button');b.className='select-btn';b.textContent=i;b.onclick=()=>{state.place=i;render()};pEl.appendChild(b)}
  const playEl=document.getElementById('playstyles');playEl.innerHTML='';PLAYS.forEach(p=>{const d=document.createElement('div');d.className='chip';d.textContent=p;d.onclick=()=>{state.play=p;render()};playEl.appendChild(d)})
  const tierEl=document.getElementById('tier-buttons');tierEl.innerHTML='';TIER3.forEach(t=>{const b=document.createElement('button');b.className='select-btn';b.textContent=t;b.onclick=()=>{state.tier=t;render()};tierEl.appendChild(b)})
}

function render(){document.querySelectorAll('#composition-chips .chip').forEach(el=>el.classList.toggle('active',el.textContent===state.comp));document.querySelectorAll('#playstyles .chip').forEach(el=>el.classList.toggle('active',el.textContent===state.play));document.querySelectorAll('#places .select-btn').forEach((b,i)=>b.classList.toggle('active',i+1===state.place));document.querySelectorAll('#tier-buttons .select-btn').forEach(b=>b.classList.toggle('active',b.textContent==state.tier))}

document.getElementById('save-match').onclick = async () => {
  const m = { id: uid(), composition: state.comp, place: state.place, play: state.play, tier: state.tier, created: Date.now() };
  await addMatch(m);
  await refresh();
  await backupData(); // ðŸ”¥ automatic backup after save
  showCheck();
  toast('Match saved and backed up');
};

function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),1600)}

/* -------------------------------
   Local Backup System (auto-save)
--------------------------------*/
let backupFileHandle = null;

// Ask user permission once
async function initBackupFile() {
  if (localStorage.getItem('bg-backup-file')) {
    try {
      backupFileHandle = await window.showOpenFilePicker({
        types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }],
        multiple: false
      }).then(files => files[0]);
    } catch (e) {
      console.warn('Backup file access canceled or failed:', e);
    }
  } else {
    const newHandle = await window.showSaveFilePicker({
      suggestedName: 'bg-tracker-backup.json',
      types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
    });
    backupFileHandle = newHandle;
    localStorage.setItem('bg-backup-file', 'granted');
    toast('Backup file created successfully');
  }
}

// Write backup file
async function backupData() {
  if (!backupFileHandle) return; // skip if not available
  try {
    const writable = await backupFileHandle.createWritable();
    const allMatches = await getAll();
    await writable.write(JSON.stringify(allMatches, null, 2));
    await writable.close();
    console.log('Backup updated');
  } catch (e) {
    console.warn('Backup failed:', e);
  }
}

// Initialize backup on first run
(async () => {
  if ('showSaveFilePicker' in window) {
    await initBackupFile();
  } else {
    console.warn('File System Access API not supported in this browser.');
  }
})();

 
// save
document.getElementById('save-match').onclick=async()=>{const m={id:uid(),composition:state.comp,place:state.place,play:state.play,tier:state.tier,created:Date.now()};await addMatch(m);await refresh();showCheck();toast('Match saved')}

// clear
document.getElementById('clear-data').onclick = async () => {
  if (!confirm('Are you sure you want to delete all match data? This cannot be undone.')) return;
  await clearAll();
  await refresh();
  toast('All data cleared');
};


async function refresh(){state.matches=await getAll();renderCards();drawCharts();updateSummary();}
function computeAvg(arr){return arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:null}
function mostCommon(arr){if(!arr.length) return '-';const f={};arr.forEach(a=>f[a]=(f[a]||0)+1);return Object.keys(f).reduce((a,b)=>f[a]>=f[b]?a:b)}

function renderCards(){
  const cards = document.getElementById('cards');
  cards.innerHTML = '';

  // Create a list of all compositions with their stats
  const compStats = COMPS.map(c => {
    const ms = state.matches.filter(m => m.composition === c);
    const avg = computeAvg(ms.map(m => m.place));
    const commonPlay = mostCommon(ms.map(m => m.play));
    const avgTier = computeAvg(ms.map(m => m.tier === 'â€”' ? 0 : m.tier));
    return { name: c, matches: ms.length, avg, commonPlay, avgTier };
  });

// Sort compositions based on state.sortBy
if(state.sortBy === 'matches'){
  compStats.sort((a,b) => b.matches - a.matches); // descending
}else if(state.sortBy === 'avg'){
  compStats.sort((a,b) => a.avg - b.avg); // ascending: lower placement is better
}



  // Render in the new order
  compStats.forEach(stat => {
    const div = document.createElement('div');
    div.className = 'comp-card comp-' + stat.name.toLowerCase();
    div.innerHTML = `
      <div class="card-title">${stat.name}</div>
      <div class="big">Avg: ${stat.matches ? stat.avg.toFixed(2) : '-'}</div>
      <div class="small">Matches: ${stat.matches}</div>
      <div class="small">Most common playstyle: ${stat.commonPlay}</div>
      <div class="small">Avg Tier 3 Turn: ${stat.matches ? stat.avgTier.toFixed(1) : '-'}</div>
    `;
    div.onclick = () => openDetails(stat.name);
    cards.appendChild(div);
  });
}


// modal functions
const modalBg=document.getElementById('modal-bg');
async function openDetails(comp){modalBg.innerHTML='';const box=document.createElement('div');box.className='modal';box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-weight:900">${comp} â€” matches</div><button id="modal-close" class="button-muted">Close</button></div><div id="modal-body"></div>`;modalBg.appendChild(box);document.getElementById('modal-close').onclick=()=>modalBg.style.display='none';modalBg.onclick=(e)=>{if(e.target===modalBg)modalBg.style.display='none'};const body=document.getElementById('modal-body');const matches=(await getAll()).filter(m=>m.composition===comp).sort((a,b)=>b.created-a.created);if(matches.length===0){body.innerHTML='<div class="small">No matches recorded for this composition.</div>'}else{matches.forEach(m=>{const row=document.createElement('div');row.className='match-row';const left=document.createElement('div');left.innerHTML=`<div style="font-weight:800">Place ${m.place}</div><div class="small">${m.play} â€¢ Tier ${m.tier==='â€”'?'â€”':m.tier}</div><div class="small">${new Date(m.created).toLocaleString()}</div>`;const del=document.createElement('button');del.className='del-btn';del.textContent='Delete';del.onclick=async(e)=>{e.stopPropagation();await deleteMatch(m.id);await refresh();openDetails(comp);toast('Deleted')};row.appendChild(left);row.appendChild(del);body.appendChild(row)})}modalBg.style.display='flex'}

// show all matches modal and allow delete
async function openAllMatches(){modalBg.innerHTML='';const box=document.createElement('div');box.className='modal';box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-weight:900">All Matches</div><button id="modal-close-all" class="button-muted">Close</button></div><div id="modal-body-all"></div>`;modalBg.appendChild(box);document.getElementById('modal-close-all').onclick=()=>modalBg.style.display='none';modalBg.onclick=(e)=>{if(e.target===modalBg)modalBg.style.display='none'};const body=document.getElementById('modal-body-all');const matches=(await getAll()).sort((a,b)=>b.created-a.created);if(matches.length===0){body.innerHTML='<div class="small">No matches recorded.</div>'}else{matches.forEach(m=>{const row=document.createElement('div');row.className='match-row';const left=document.createElement('div');left.innerHTML=`<div style="font-weight:800">${m.composition} â€¢ Place ${m.place}</div><div class="small">${m.play} â€¢ Tier ${m.tier==='â€”'?'â€”':m.tier}</div><div class="small">${new Date(m.created).toLocaleString()}</div>`;const del=document.createElement('button');del.className='del-btn';del.textContent='Delete';del.onclick=async(e)=>{e.stopPropagation();await deleteMatch(m.id);await refresh();openAllMatches();toast('Deleted')};row.appendChild(left);row.appendChild(del);body.appendChild(row)})}modalBg.style.display='flex'}

document.getElementById('show-all').onclick = ()=> openAllMatches();

/* C) Chart improvements: color mapping, glow, animation, shadow */

/* Colors aligned to composition gradient primary tones (keeps mapping minimal and consistent) */
const COMP_COLORS = {
  'Demons':'#9b4dff',
  'Dragons':'#ff6b6b',
  'Mechs':'#f4d03f',
  'Murlocs':'#2ecc71',
  'Quilboar':'#d35400',
  'Pirates':'#95a5a6',
  'Beasts':'#27ae60',
  'Elementals':'#3498db',
  'Undead':'#2c3e50',
  'Naga':'#1e90ff',
  'Menagerie':'#8e44ad'
};
/* Generic color set for playstyle / tier charts (keeps them visually cohesive) */
const PLAY_COLORS = [ '#de7676','#de7676', '#de7676'];
const TIER_COLORS = ['#dedc76', '#dedc76', '#dedc76', '#dedc76'];


function drawBarChartAnimated(canvas, items, colorForItemFn) {
  // Draw animated horizontal bars that grow. Uses devicePixelRatio scaling and shadow for "thick" shadow/glow.
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const width = canvas.clientWidth;
  const rowHeight = 44;
  canvas.width = width * dpr;
  canvas.height = items.length * rowHeight * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,width,canvas.height/dpr);

  // precompute values & target widths
  const values = items.map(it => (it.value===null ? null : it.value));
  // For placement averages (1..8), smaller is better; we map 1->full width, 8->near zero
  function placementToRatio(v) { if(v===null) return 0; const r = (8 - v) / 7; return Math.max(0, Math.min(1, r)); }

  const targets = values.map(v => placementToRatio(v) * width);

  // animation variables
  const duration = 700; // ms
  const start = performance.now();

  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

  function frame(now){
    const t = Math.min(1, (now - start) / duration);
    const ease = easeOutCubic(t);
    ctx.clearRect(0,0,width,canvas.height/dpr);
    ctx.font = '14px Inter, system-ui, Arial, sans-serif';
    ctx.textBaseline = 'middle';

    items.forEach((it, i) => {
      const y = i * rowHeight + 6;
      const targetW = targets[i];
      const currentW = targetW * ease;
      const col = colorForItemFn ? colorForItemFn(it, i) : '#fff';

      // thick shadow / glow
      ctx.save();
      ctx.fillStyle = col;
      ctx.shadowColor = col;
      ctx.shadowBlur = 6; // glow
      ctx.fillRect(0, y, currentW, 32);
      ctx.restore();

// draw border outline
ctx.strokeStyle = 'rgba(255,255,255,0.4)'; // or use col for colored border
ctx.lineWidth = 2;
ctx.strokeRect(0.5, y + 0.5, currentW - 1, 32 - 1);

      // label
      ctx.fillStyle = '#ffffff';
      const labelText = `${it.name} (${it.matches? (it.value===null ? '-' : it.value.toFixed(2)) : '-'})`;
      ctx.fillText(labelText, 8, y + 16);
    });

    if (t < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function drawCharts(){
  // Average placement per composition (map each comp to its color)
  let compVals=COMPS.map(c=>{const ms=state.matches.filter(m=>m.composition===c);const avg=computeAvg(ms.map(m=>m.place));return{name:c,value:avg,matches:ms.length}});

  // sort by value similar as before (nulls last)
  compVals.sort((a,b)=>{if(a.value===null&&b.value===null)return 0;if(a.value===null)return 1;if(b.value===null)return -1;return a.value-b.value});

  const avgCanvas = document.getElementById('avg-place-chart');
  drawBarChartAnimated(avgCanvas, compVals, (it,i)=>COMP_COLORS[it.name] || '#fff');

  // Playstyle chart: map playstyles to the first N composition colors (keeps them visually consistent)
  let playVals=PLAYS.map(p=>{const ms=state.matches.filter(m=>m.play===p);const avg=computeAvg(ms.map(m=>m.place));return{name:p,value:avg,matches:ms.length}});
  playVals.sort((a,b)=>{if(a.value===null)return 1;if(b.value===null)return -1;return a.value-b.value});
  const playCanvas = document.getElementById('playstyle-chart');
  drawBarChartAnimated(playCanvas, playVals, (it,i)=> PLAY_COLORS[i % PLAY_COLORS.length]);


  // Tier chart
  let tierList=TIER3.filter(x=>'â€”'!==x);
  let tierVals=tierList.map(t=>{const ms=state.matches.filter(m=>m.tier==t);const avg=computeAvg(ms.map(m=>m.place));return{name:String(t),value:avg,matches:ms.length}});
  tierVals.sort((a,b)=>{if(a.value===null)return 1;if(b.value===null)return -1;return a.value-b.value});
  const tierCanvas = document.getElementById('tier-chart');
drawBarChartAnimated(tierCanvas, tierVals, (it,i)=> TIER_COLORS[i % TIER_COLORS.length]);
}

/* Update small summary section (A) */
function updateSummary(){
  const total = state.matches.length || 0;
  const avg = computeAvg(state.matches.map(m=>m.place));
  document.getElementById('totalMatches').textContent = total;
  document.getElementById('avgPlacementOverall').textContent = avg ? avg.toFixed(2) : '-';
}

document.getElementById('sort-cards').onchange = (e) => {
  state.sortBy = e.target.value;
  renderCards();
}

/* initialize */
(async()=>{await openDb();buildUI();render();await refresh()})();

// export/import
const exportBtn=document.getElementById('export-data');exportBtn.onclick=async()=>{const data=await getAll();const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='bg-matches-'+(new Date()).toISOString().slice(0,10)+'.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)};
const importBtn=document.getElementById('import-data');importBtn.onclick=()=>{const input=document.createElement('input');input.type='file';input.accept='application/json';input.onchange=async()=>{const file=input.files[0];if(!file)return;const text=await file.text();try{const arr=JSON.parse(text);const tx=db.transaction('matches','readwrite');const store=tx.objectStore('matches');arr.forEach(m=>{if(!m.id)m.id=uid();store.put(m)});tx.oncomplete=()=>refresh()}catch(err){alert('Import failed: '+err.message)}};input.click()};

</script>
  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker registered!'))
    .catch(err => console.log('Service Worker failed:', err));
}
</script>
</body>
</html>
